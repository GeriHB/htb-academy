# Automation and Prevention

## Automated Scanning

We may need manual work in some cases to craft advanced payloads or use custom techniques.

But in a lot of times we can use automated methods to identify and exploit trivial LFI vulnerabilities.

### Fuzzing Parameters

HTML forms usually are well secured.

But the page can have other exposed parameters not linked to any HTML forms, which normal users will not usually access.

Thus - fuzzing exposed parameters, as they may be not as secure as public ones.

Example - fuzz the page for common `GET` parameters:

```sh
ffuf -w /opt/useful/seclists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u 'http://<SERVER_IP>:<PORT>/index.php?FUZZ=value' -fs 2287
```

When an exposed parameter not linked to any forms is identified we can proceed to perform LFI tests.

### LFI wordlists

In many cases we can run a quick test on a parameter and see if it's vulnerable to common LFI payloads.

An example can be to use the `LFI-Jhaddix` wordlist:

```sh
ffuf -w /opt/useful/seclists/Fuzzing/LFI/LFI-Jhaddix.txt:FUZZ -u 'http://<SERVER_IP>:<PORT>/index.php?language=FUZZ' -fs 2287
```

### Fuzzing Server Files

There are some server files that can be helfpul for LFI exploitation:
- Server webroot path
- Server configuration files
- Server logs

#### Server webroot path

If we wanted to locate a file we oploaded but can't reach its `/uploads` directory through relative path `../..uploads` we may need to know the server webroot path, and locate it via absolute path.

So we can fuzz for `index.php` file through common webroot paths.

Depending on the LFI situation, we may need to add a few back directories and then add the index.php afterwards.

```sh
ffuf -w /opt/useful/seclists/Discovery/Web-Content/default-web-root-directory-linux.txt:FUZZ -u 'http://<SERVER_IP>:<PORT>/index.php?language=../../../../FUZZ/index.php' -fs 2287
```

#### Server Logs/Configurations

For example we need the log path for the log poisoning attack.

```sh
ffuf -w ./LFI-WordList-Linux:FUZZ -u 'http://<SERVER_IP>:<PORT>/index.php?language=../../../../FUZZ' -fs 2287
```

Some **LFI tools** which are used to automate the process are:
- LFISuite
- LFiFreak
- liffy

### File Inclusion Prevention

Avoid passing any user-controlled inputs into any file inclusion functions or APIs - dynamically load assets on the back-end, with no user interaction whatsoever.

Whenever the mentioned functions in this module are used, no user ipnut should go to them.

Another way - have a limited whitelist for user inputs, having default values for all other inputs.

If there is an existing web app, create a whitelist that contains all existing paths used in the front-end and utilize this list to match the user input.

#### Preventing Directory Traversal

Use programming languages or framework's built-in tool to pull only the filename.

For example PHP's `basename()` .

#### Web Server Configuration

For example globally disable the inclusion of remote files. In PHP this can be done by setting off the `allow_url_fopen` and `allow_url_include`.

Lock web apps to their web root directory, preventing from accessing non-web related files.

This can be done by running the app within `Docker`. 

Can be done also by adding `open_basedir = /var/www` in the `php.ini`.

#### WAF

The universal way to harden apps is to utilize WAFs, such as `ModSecurity`.

Most important is to avoid **false positives** and blocking non-malicious requests. 